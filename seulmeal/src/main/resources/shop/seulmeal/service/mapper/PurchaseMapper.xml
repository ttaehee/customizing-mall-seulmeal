<?xml version="1.0" encoding="UTF-8"?> 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
           "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="shop.seulmeal.service.mapper.PurchaseMapper"> 

	<resultMap id="customProductSelectMap" type="customProduct">
    	<result property="customProductNo" 		column="customproduct_no" 	jdbcType="NUMERIC"/>
	
		<association property="buyer" javaType="user" >
			<result property="userId" 	 		column="user_id" 			jdbcType="VARCHAR"/>
		</association>
		
		<association property="purchaseProd" javaType="product" >
			<result property="productNo" 		column="product_no" 		jdbcType="NUMERIC"/>
		</association>
	</resultMap>


	<!-- custom_pars -->
	<insert id="insertCustomParts">
		INSERT INTO customparts
		(customparts_no, customproduct_no, productparts_no, parts_no, gram)
		values((seq_customparts_no.NEXTVAL),#{customProduct.customProductNo:NUMERIC}, 
		#{productParts.productPartsNo:NUMERIC}, #{parts.partsNo:NUMERIC}, 
		#{gram:NUMERIC})
		<selectKey keyProperty="customPartsNo" resultType="int" order="AFTER">
			SELECT seq_customparts_no.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<select id="getCustomParts" resultType="customParts">
		SELECT * FROM customparts
		<where>
			customparts_no = #{customPartsNo}
		</where>
	</select>
	
	<select id="getListCustomParts" resultType="customParts" parameterType="map">
		SELECT *
		FROM (SELECT inner_table.*, ROWNUM AS row_seq
			FROM (SELECT prod.*, parts.*
			    FROM customparts cparts
				WHERE prod.customproduct_no=parts.customproduct_no AND user_id=#{user.userId} AND cart_status='1'
				ORDER BY custom_product.customproduct_no) inner_table
			WHERE ROWNUM &lt; = #{endRowNum})
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
	</select>
	
	<delete id="deleteCustomParts" parameterType="int">
        DELETE FROM customparts WHERE customproduct_no = #{customProductNo}
    </delete>


	<!-- custom_product -->
	<insert id="insertCustomProduct">
		INSERT INTO customproduct
		(customproduct_no, user_id, product_no, count, 
		cart_status, status, reg_date)
		values((seq_customproduct_no.NEXTVAL),#{user.userId}, #{product.productNo}, 
		#{count:NUMERIC}, #{cartStatus:CHAR}, 
		#{status:CHAR}, SYSDATE)
		<selectKey keyProperty="customProductNo" resultType="int" order="AFTER">
			SELECT seq_customproduct_no.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<select id="getCustomProduct" resultType="customProduct">
		SELECT *
		<where>
			customproduct_no = #{customProductNo}
		</where>
	</select>
	
	<select id="getListCustomProduct" resultType="customProduct" parameterType="map">
		SELECT *
		FROM (SELECT inner_table.*, ROWNUM AS row_seq
			FROM (SELECT cprod.*,cparts.*
			    FROM customproduct cprod, customparts cparts
				WHERE cprod.customproduct_no=cparts.customproduct_no AND user_id=#{user.userId} AND cart_status='1'
				ORDER BY cprod.customproduct_no) inner_table
			WHERE ROWNUM &lt; = #{endRowNum})
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
	</select>
	
	<update id="updateCustomProduct">
		UPDATE customproduct
		<set>
			purchase_no=#{purchase.purchaseNo:NUMERIC}
		</set>
		<where>
			customproduct_no = #{customProductNo}
		</where>
	</update>
	
	<update id="deleteCustomProduct">
		UPDATE customproduct
		<set>
			cart_status = '1'
		</set>
		<where>
			customproduct_no = #{customProductNo}
		</where>
	</update>
	

	<!-- purchase -->
	<insert id="insertPurchase">
		INSERT INTO purchase
		(purchase_no, user_id, price, delivery_price, address, name, phone, 
		message, purchase_status, reason, image, status, reg_date, 
		payment_condition, imp_uid, amount)
		values((seq_purchase_no.NEXTVAL),#{user.userId},#{price:NUMERIC}, 
		#{deliveryPrice:NUMERIC}, #{address:VARCHAR}, #{name:VARCHAR}, 
		#{phone:VARCHAR}, #{message:VARCHAR}, #{purchaseStatus:CHAR}, 
		#{reason:VARCHAR}, #{image:VARCHAR}, #{status:CHAR}, 
		SYSDATE, #{paymentCondition:CHAR},#{imp_uid:VARCHAR}, 
		#{amount:NUMERIC})
		<selectKey keyProperty="purchaseNo" resultType="int" order="AFTER">
			SELECT seq_purchase_no.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<select id="getPurchase" resultType="purchase">
		SELECT * FROM purchase
		<where>
			purchase_no = #{purchaseNo}
		</where>
	</select>
	
	<select id="getListPurchase" resultType="purchase" parameterType="map">
		SELECT *
		FROM (SELECT inner_table.*, ROWNUM AS row_seq
			FROM (SELECT * FROM purchase
				WHERE status='0'
				<if test="searchCondition != null">
					<if test="searchCondition == 0">
						AND reg_date=SYSDATE
					</if>
					<if test="searchCondition == 1">
						AND reg_date=#{regDate}
					</if>
					<if test="searchCondition == 2">
						AND reg_date=#{regDate}
					</if>
					<if test="searchCondition == 3">
						AND reg_date=#{regDate}
					</if>
				</if>
				ORDER BY purchase_no) inner_table
			WHERE ROWNUM &lt; = #{endRowNum})
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
	</select>
	
	<update id="updatePurchaseCode">
		UPDATE purchase
		<set>
			purchase_status=#{purchaseStatus:CHAR}
		</set>
		<where>
			purchase_no = #{purchaseNo}
		</where>
	</update>
	
	<update id="deletePurchase">
		UPDATE purchase
		<set>
			status = '1'
		</set>
		<where>
			purchase_no = #{purchaseNo}
		</where>
	</update>

	
	<!-- ROW Count -->
	<select id="getTotalCount" resultType="int" parameterType="map">
		SELECT COUNT(*)
	  	FROM( SELECT * FROM purchase
	  	<where>
			purchase_status = #{purchaseStatus} AND status = '0') countTable
		</where>
	</select>


</mapper>